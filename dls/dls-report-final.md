
# Отчет о финальном проекте DLS
Трек детекция изображений. Продуктовый.

## Постановка задачи
Есть реальная задача фриланса: сделать сервис распознавания визиток. Сервису отправляется фото визитки, возвращается json,
с содержимым: почта, телефон, имя и другие поля.
Любой язык, фреймворки, танцы с бубном. Упаковка в докер, сервис должен быть запущен на старой виртуалке. 
~99.5% визиток с англоязычными данными. Скорость обработки не особо критична. 
А вот точность важна, особенно всякие точки, редкие шрифты, а так же важно правильное распределение по полям выходного json-а.

На основании этого сервиса было сделан mvp, добавлен ui, сохранение и др. Пользователь загружает фотку, получает распознанный текст,
собирает коллекцию своих визиток и не боится потерять картонные карточки. 

## Подходы к решению
1. Первым вариантом решения задачи было использовать [tesseract](https://github.com/tesseract-ocr/tesseract) 
и дообученную yolo модель которая детектит текст. 
Текст вырезается из картинки и отправляется tesseract (иначе вообще не работало). 
Модель справлялась с задачей отлично, а вот tesseract так себе, даже когда ему приносили текст на блюдечке. 
Были многочисленные (очень многочисленные) попытки подкрутить яркость, контраст, резкость, и прочее на изображении, 
чтобы тессетарту проще жилось. Но в одном месте что-то становилось лучше, а в другом хуже. 
В конце концов было принято решение отказаться от тессеракта.
2. Вторым решением было использовать [paddleocr](https://github.com/PaddlePaddle/PaddleOCR). Мне она показалась лучше справляется чем [easyocr](https://github.com/JaidedAI/EasyOCR).
Но они обе на порядок лучше тессеракта. Модель yolo для детекции текста пришлось выкинуть (жалко труды конечно) вместе с тессерактом. <br>
Все работало на ура по умолчанию в paddle.<br>
Случилась внезапная оказия при деплое на старую виртуаклу. Paddleocr работает на платформе paddlepaddle которая супербыстрая на современных процах,
а в старой виртуалке проц без набора нужных команд, и там paddle просто падает. Нужно пересобрать на onnx модель, чтобы заработало. 
В этом помогла либа [rapidOCR](https://github.com/RapidAI/RapidOCR), с которой просто было перейти на paddle формата onnx (либа существенно облегчает жизнь).
3. Следующим требованием когда понадобилось пересмотреть архитектуру, было: в некоторых карточках есть только графические 
обозначение поля, т.е значок скайпа перед скайпом, значок телеграмма перед телеграммом, и тд, и эти поля не правильно распределялись. 
Т.е распределение было на основе логических выводов по самому тексту, например @Vasya это будет телеграм, 
а если нарисован значок тг и Vasya без префикса @, то сервис не поймет что это телеграм. Так же со скайпом. 
Было принято обучить модель для этих целей. Идея такая: модель определяет бокс карточки, и боксы значков, а paddle детектит текст, 
сопоставляем координаты, и понимает что где скайп, где телеграм, логотип обычно рядом с названием организации и тд. 
Так же предварительно перед отправкой в paddle вырезаю из изначального фото только интересующую часть, кде карточка.

## Детали реализации и особенности
- Язык Go (да, я люблю go, пишу, умею, практикую).
- RapidOCR (paddle onnx внутри) для текста.
- Моя обученная yolo onnx для боксов и обработка сырых данных от yolo на go. 

Процесс такой: 
- Загруженное изображение если нужно поворачиваем, основываясь на exif данных. 
- Чуть-чуть добавляю светлости и контраста
- Модель yolo onnx детектит блоки карточки и значков
- Вырезаю квадрат в котором находится карточка (paddle так быстрее работает)
- Отправляю в paddle, получаю боксы с текстом.
- Смерживаю вертикально расположены блоки с текстом. Например, имя и фамилия в двух строчках написаны, и они попадают в два разных блока. 
- Распределяю текст по полям.
- Если есть спорный текст, сверяюсь с найденными значками по координатам. (это еще в разработке)
- Возвращаю распределенный текст в виде json-a

К сервису добавлен ui, стало похоже на mvp. Когда прилеплю авторизацию будет пет проект.
Честно говоря, не особо заметила разницу в моделях yolov8 и yolov9 обученных на 60 эпохах. 
Полагаю нужно думать в сторону датасета, потому что некоторые классы мало представлены и сами значки маленькие. 
Yolov10 уже вышла, но интересно что у нее отличается формат вывода onnx модели, и нужно переписывать всю обвязку, пока не знаю как.
Поэтому сфокусировалась на версиях v8 и v9.

## Примечания 
В проекте используется две модельки (paddle, моя yolo) для работы. Можно рассматривать как итоговый проект целиком на тему применение моделей в продукте, 
если вам не нужны все исходник (извините, собственность заказчика, хотя все написано лично в одиночку). 
Или, если нужны исходники, можно рассматривать часть с моей моделькой yolo как интеграцию, ее я выложу и демонстрацию использования в go сервисе.
К слову в основном сервисе никакого рокет сайнса нет, просто распределяется текст используя регурярки, по полям. 

## Демонстрация работы
Выглядит это так 
![img](Screenshot%20from%202024-07-12%2016-18-18.png)

### Видео работы Card-detector 
[![MVP Card detector](https://img.youtube.com/vi/_SnE98tgp7Q/0.jpg)](https://youtu.be/_SnE98tgp7Q) <br>
Так же это видео лежит в текущей папке [card-detector.mkv](card-detector.mkv)

### Запущен на сервере
Запущено на маленькой, слабой виртуалке, поэтому работает медленно.
Загружайте, пожалуйста, jpeg с англоязычной визиткой. Русского сейчас нет. 

- Демонстрация работы самого mvp **Card-detector** http://176.58.32.250:8080
- Демонстрация работы onnx модели в golang проекте. **Card-detect-demo** http://176.58.32.250:8081

## Исходники и ресурсы
Датасет лично подобранный и размеченный https://universe.roboflow.com/byby-s0bex/my-123 <br>
Обучение велось в kaggle, тут ничего особенного [kaggle notebook](https://www.kaggle.com/code/olgagrazhdanova/yolo-with-ultralystic).<br>
Попыток было много [wandb](https://wandb.ai/i-wonderful/yolo-cards) <br>
Исходники сервиса демки onnx в go-проекте в [репозиторий в котором сейчас находитесь](https://github.com/i-wonderful/card-detect-demo).<br>

## Планы
- Пофиксить несоответствия и баги в алгоритмах распределения.
- Русский язык.
- Добавить авторизацию, нормальную бд.
- Причесать ui.

## Размышления
Буду рада фидбеку, замечаниям, предложениям. 
Может быть вы знаете еще какие-нибудь подходы, модели для распознавания текста, русского языка, рукописного текста. 
Эта сфера очень интересна. 
Может быть подскажете ml подход для распределения текста по категориям типа email, адрес, имя, компания и тд. 
Или исправления ошибок чтения, например .con вместо .com. 
Сейчас там распределение работает на основе регулярок и домыслов, достаточно громоздко и колхозно. 
В целом мне интересно именно практическое применение ml, особенно в go проектах.

Спасибо про что дочитали этот логрид и спасибо за курс :thumbsup:

Если что-то не открывается/не запускается, или другие вопросы, <br> 
тг [@Helga_x](http://t.me/Helga_x), <br>
почта [dvl.java@gmail.com](mailto:dvl.java@gmail.com)

